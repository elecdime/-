<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bbs.mapper.boardMapper">


	
	<select id="boardView" resultType="com.bbs.domain.bbsDTO">
		select
		b.bbsno, b.title,
		b.cateCode, c.cateCodeRef, c.cateName, writer,bbsgroup,bbsDent,
		endDate,regDate,viewCnt
		,content
		from board_jh b
		inner join categori_jh c
		on
		b.cateCode = c.cateCode
		where b.bbsno =#{bbsno}
	</select>

	<insert id="boardinsert">

	insert into board_jh
	(bbsno,writer,title,content,bbsGroup,BOARD_PARENT,cateCode,notice,startDate,endDate)
	VALUES
	(BOARD_JH_SEQ.nextval,#{writer},#{title},#{content},(select max(bbsno)+1 from board_jh),0,#{cateCode,
	jdbcType=VARCHAR},#{notice},#{startDate},#{endDate})

	</insert>
	<select id="categori" resultType="com.bbs.domain.CategoriDTO">
		select level, cateName,
		cateCode, cateCodeRef from categori_jh
		start with cateCodeRef is null
		connect by prior cateCode = cateCodeRef


	</select>
	<update id="boardupdate">
		update board_jh
		set

		cateCode = #{cateCode},
		title =
		#{title},
		writer = #{writer},
		content = #{content},
		regDate = SYSDATE 
		
		where bbsno = #{bbsno}

	</update>
	<delete id="boarddelete">
		delete
		board_jh
		where bbsno = #{bbsno}
		or board_parent =#{bbsno}
		or bbsgroup = #{bbsno}
		
	</delete>
	<update id="viewcnt">
		update board_jh
		set
		viewCnt = viewcnt+1
		where
		bbsno
		=#{bbsno}


	</update>
	<update id="notice1">
		  <![CDATA[
		update board_jh
		set notice = 1
		where startdate <= sysdate and sysdate-1 <= enddate
			]]>
	</update>
	<update id="notice2">
		<![CDATA[
		update board_jh
		set notice = 0
		where sysdate > enddate
		]]>
	</update>
	    <insert id="insertfile" parameterType="hashMap">
		INSERT INTO file_jh(
			FILE_NO,
			bbsno,
			orgfile,
			savefile
		
		)VALUES(
			file_no_seq.NEXTVAL,
			(select max(bbsno)+1 from board_jh) ,
			#{orgfile},
			#{savefile}
	
		)
    </insert>
   <!-- 첨부파일 조회 -->
<select id="selectFileList" parameterType="int"
	resultType="hashMap">
		<![CDATA[
	
     SELECT FILE_NO,
		   orgfile ,savefile,
           del_file
	  FROM file_jh
	 WHERE bbsno = #{bbsno}
     AND del_file ='N'
     order by file_no asc
	]]>
</select>
<select id="selectFileInfo" parameterType="Map" resultType="hashMap">
	SELECT 
		savefile,
		orgfile
	FROM file_jh
	WHERE FILE_NO = #{file_no}
</select>

	<insert id="replyinsert">
   INSERT 
    INTO board_jh
    (
          bbsno
        , bbsGroup
        , bbsDent
        , board_parent
        , writer
        , title
        , content
  
     
    ) 
    VALUES 
    (
         BOARD_JH_SEQ.nextval
      , #{bbsGroup}
       , #{bbsDent} + 1
       , #{bbsno}
       , #{writer}
       , #{title}
       , #{content}
      
    )

	</insert>

	<update id="nofile">
		<![CDATA[
	update file_jh
    set del_file='y'
    where bbsno > ( 
  	select  Max(bbsno) from board_jh)
 
		]]>
	</update>
	
    
    <select id="count" resultType="int">
 select count(bbsno) from board_jh
</select>


<select id="listSearch" resultType="com.bbs.domain.bbsDTO"
	parameterType="com.bbs.domain.Criteria">


                                 SELECT * FROM
                            (SELECT  ROWNUM AS rnum,
                                 data.*
                            FROM
                                    (SELECT LEVEL,
                                            bbsno,
                                           title,
                                           writer,                                       
                                         content,
                                            viewcnt,
                                             bbsgroup,
                                             BOARD_PARENT,
                                            regDate,
                                            notice,
                                            startDate,
                                            endDate,
                                            bbsDent,cateCode
                                  FROM board_jh
                                          	 <include refid="search"></include>
                                  START with board_parent = 0
        CONNECT BY PRIOR bbsno=board_parent
       
         ORDER SIBLINGS BY notice desc,regdate desc, bbsgroup ) 
                            data)
                  where rNum between #{rowStart} and #{rowEnd}


        

</select>
<sql id="search">
        <if test="searchType != null">
		<if test="searchType == 't'.toString()">where title like '%' || #{keyword} || '%'</if>
		<if test="searchType == 'c'.toString()">where content like '%' || #{keyword} || '%'</if>
		<if test="searchType == 'w'.toString()">where writer like '%' || #{keyword} || '%'</if>
		<if test="searchType == 'tc'.toString()">where (title like '%' || #{keyword} || '%')
													or (content like '%' || #{keyword} || '%')</if>
	</if>
</sql>






<select id="countSearch" resultType="int">
	select count(bbsno)
		from board_jh
			<include refid="search"></include>
<![CDATA[
			and bbsno > 0
]]>
</select>
    <insert id="updatefile" parameterType="hashMap">
		INSERT INTO file_jh(
			FILE_NO,
			bbsno,
			orgfile,
			savefile
		
		)VALUES(
			file_no_seq.NEXTVAL,
			#{bbsno} ,
			#{orgfile},
			#{savefile}
	
		)
    </insert>
    	<update id="delfile">
		<![CDATA[
	update file_jh
    set del_file='y'
    where file_no = #{file_no}
 
		]]>
	</update>

    <select id="delfiley" resultType="com.bbs.domain.FileDTO">
select * from file_jh
where del_file='y'
</select>

<delete id="sqlfiledel">
DELETE FROM file_jh
where del_file='y'

</delete>
 	<update id="delbbsfile">
 	update file_jh
    set del_file='y'
    where bbsno = #{bbsno}
 	</update>
</mapper>
